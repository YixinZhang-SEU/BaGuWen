# 小林coding

## TCP/IP网络模型

### 应用层

> 协议：HTTP（超文本传输协议）、FTP（文件传输协议）、Telnet（Internet远程登陆服务的标准协议）、DNS（域名系统）、SMTP（电子邮件传输协议）

应用层在用户态，传输层及以下在内核态。



### 传输层

> 协议：TCP（传输控制协议）、UDP（用户数据报协议）

TCP相比UDP多了流量控制、超时重传、拥塞控制等特性，保证数据包能可靠地传输给对方。

UDP不保证数据包是否可以抵达对方，但是它的实时性相对更好，传输效率也高。

MSS(最大报文段长度)：TCP连接建立时协商的每一个TCP报文段所能承载的最大数据长度（不包括头部）。

> 各个端口对应的服务
>
> 21：FTP
> 23：Telnet
> 25：SMTP
> 53：DNS
> 80：HTTP
> 443：HTTPS
> 8080：WWW，网页



### 网络层

> 协议：IP协议、ARP（地址解析协议）、ICMP（Internet控制报文协议）

MTU（最大传输单元）：发送方所能接受的数据报最大长度（单位为字节），超过MTU可能会被路由器拒绝转发。MTU是加上了IP头部的长度，以太网中一般为1500字节。

IPv4共有32位，IPv6有128位。将IP地址分为网络号和主机号，用子网掩码和ip地址进行按位与计算，可以得到网络号。`10.100.122.0/24`，后面的`/24`表示就是 `255.255.255.0` 子网掩码。

**IP 协议的寻址作用是告诉我们去往下一个目的地该朝哪个方向走，路由则是根据「下一个目的地」选择路径。寻址更像在导航，路由更像在操作方向盘**。



### 数据链路层

> 协议：IP协议、ARP（地址解析协议）



### 各层数据的传输单位

- 网络接口层的传输单位是帧（frame）
- IP 层的传输单位是包（packet）
- TCP 层的传输单位是段（segment）
- HTTP 的传输单位则是消息或报文（message）



## 键入网址到网页显示，期间发生了什么？

### HTTP

1. 解析URL
2. 生成HTTP请求报文



### DNS

查询目标服务器域名对应的IP地址

浏览器和操作系统的缓存中都会存储



### 协议栈

通过DNS获取到目的IP后，就可以把HTTP的传输工作交给操作系统中的**协议栈**。

![img](网络.assets/7.jpg)

### TCP

#### 报文头部

![TCP 包头格式](网络.assets/8.jpg)

状态位：`SYN` 是发起一个连接，`ACK` 是回复，`RST` 是重新连接，`FIN` 是结束连接。

#### 查看TCP连接状态的命令

```nginx
netstat -napt
```



### IP

#### 填写源IP地址

假设客户端有多个网卡，就会有多个 IP 地址，在填写源地址 IP 时，就需要判断到底应该填写哪个地址。这个判断相当于在多块网卡中判断应该使用哪个一块网卡来发送包。**这个时候就需要根据路由表规则，来判断哪一个网卡作为源地址 IP。**

```nginx
route -n  # 查看路由表
```

![路由表](网络.assets/15.jpg)

eth0, eth1是网卡。

目标地址和子网掩码都是 `0.0.0.0`表示**默认网关**，如果其他所有条目都无法匹配，就会自动匹配这一行。并且后续就把包发给路由器，`Gateway` 即是路由器的 IP 地址。



#### IP报文生成

![![IP 包头格式](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/14.jpg)](网络.assets/17.jpg)



### MAC

在 MAC 包头里需要发送方 MAC 地址和接收方目标 MAC 地址，用于**两点之间的传输**。

MAC 包头的**协议类型**包括：`0800`：IP 协议、`0806`：ARP 协议。

发送包时要获取对方MAC地址：

- 先查询 **ARP 缓存**，如果其中已经保存了对方的 MAC 地址，就不需要发送 ARP 查询，直接使用 ARP 缓存中的地址。
- 而当 ARP 缓存中不存在对方 MAC 地址时，则发送 ARP 广播查询。

至此，报文如下图：

![MAC 层报文](网络.assets/21.jpg)



### 网卡

网络包只是存放在内存中的一串二进制数字信息，没有办法直接发送给对方。因此，我们需要将**数字信息转换为电信号**，才能在网线上传输。负责执行这一操作的是**网卡**，要控制网卡还需要靠**网卡驱动程序**。

网卡驱动获取网络包之后，会将其**复制**到网卡内的缓存区中，接着会在其**开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列**。



### 交换机

交换机将网络包**原样**转发到目的地。交换机工作在 MAC 层，也称为**二层网络设备**。

> **交换机与网卡区别**
>
> 计算机的**网卡本身具有 MAC 地址**，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，如果不是发给自己的则丢弃；
>
> 相对地，交换机的端口不核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中。因此，和网卡不同，**交换机的端口不具有 MAC 地址**。

#### 广播地址

- MAC 地址中的 `FF:FF:FF:FF:FF:FF`
- IP 地址中的 `255.255.255.255`



### 路由器

> **路由器与交换机区别**
>
> **路由器**是基于 IP 设计的，俗称**三层**网络设备，路由器的各个端口都具有 MAC 地址和 IP 地址，类似网卡；
>
> **交换机**是基于以太网设计的，俗称**二层**网络设备，交换机的端口不具有 MAC 地址。

#### 接收包

错误校验后，检查MAC头部的接收方MAC地址，丢弃不是发给自己的包。

接收包后，丢弃MAC头部。因为**MAC 头部的作用就是将包送达路由器**，其中的接收方 MAC 地址就是路由器端口的 MAC 地址。因此，当包到达路由器之后，MAC 头部的任务就完成了。

#### 转发包

根据路由表转发，如果网关是一个IP地址，则这个IP地址就是我们要转发到的目标地址，说明还未抵达终点要继续转发，否则已抵达终点。得到IP地址后也要转换成MAC地址，同样查询**ARP缓存**，如果查不到就发送ARP查询。

**源 IP 和目标 IP 始终是不会变的，一直变化的是 MAC 地址**，因为需要 MAC 地址在以太网内进行**两个设备**之间的包传输。







































































